var fs = require('fs');

var routing_table = {};

var webroot = __dirname + '/../../templates';

//////////////
//    All the various ways to tell the server "it's this kind of file"
//
var header_handlers = {};
function add_header_handler(key, type) {
	key = key.toLowerCase();
	header_handlers[key] = function(resp, length) {
		resp.writeHead(
			200,
			{
				'Content-Length': length,
				'Content-Type': type,
			}
		);
	}
}
var mime_types = {
	'js' : 'application/javascript',
	'html' : 'text/html',
	'jpeg' : 'image/jpeg',
	'jpg' : 'image/jpeg',
	'css' : 'text/css',
	'png' : 'image/png'	
};
for ( type in mime_types ) {
	add_header_handler( type, mime_types[type] );
}
function get_header_handler(key) { return header_handlers[ key.toLowerCase() ] }
//////////////


var defaultHandler = function(req, resp) {
	var body = '<h1>The page you requested could not be found</h1>';
	(get_header_handler('html'))(resp, body.length);
	resp.end(body);
}

add_handler(   // Home page
	'/',
	function(req, resp) {
		fs.readFile(
			'templates/html/home.html',
			'utf8',
			function (err, data) {
				(get_header_handler('html'))(resp, data.length);
				resp.end(data);
			}
		)
	}
);

function assetHandler(req, resp) {
	var path = url.parse(req.url).pathname;
	var results = path.match(/^.+\.(.+)$/);
	var extension = results[ results.length -1 ];
	
	fs.readFile(
		webroot + path,
		'utf8',
		function (err, data) {
			var handler = get_header_handler(extension);
			handler(resp, data.length);
			resp.end(data);
		}
	)
}

function add_handler(path, func) { routing_table[path] = func }

function get_handler(path) {
	if ( path.match(/^\/assets\//) ) { return assetHandler }
	return routing_table[path] || defaultHandler;
}

exports.get_handler = get_handler;
exports.add_handler = add_handler;
